# 2026-02-21 개발 종료

- 로컬 소스 최신화 완료 (`git pull`).

---

## 오늘 작업 요약

### 1. 스케줄러 기동 오류 수정

- **topicSelector.js**: `selectDailyTopicsWithQuota` 내 동일 스코프에서 `const plan` 중복 선언 제거. fallback 구간 변수명을 `fallbackPlan`으로 변경하여 SyntaxError 해소.
- **telegram.js**: `formatDailyReport`에서 `plan`이 없거나 배열이 아닐 때 방어 처리 (조기 return).
- **scheduler.js**: 일일 보고 메시지 생성·전송을 try/catch로 감싸 예외 시에도 프로세스 종료 없이 로그만 남기도록 처리.

### 2. MongoDB 재시작 루프 원인 및 조치

- **원인**: 데이터 볼륨의 featureCompatibilityVersion이 8.2로 기록되어 있는데, 컨테이너는 `mongo:7` 사용. 7.x는 FCV 8.2를 지원하지 않아 기동 시 종료(exit 62).
- **조치**: `docker-compose.yml`에서 mongo 이미지를 `mongo:7` → `mongo:8`로 변경. 기존 데이터 그대로 사용 가능.

### 3. 서버 명령어 문서 보강 (SERVER_COMMANDS.md)

- 프로젝트 루트 `/home/ubuntu/chat-app`, Compose 명령은 **`docker-compose`(하이푈)** 사용 안내 추가.
- **MongoDB 이미지만 갱신** 절차 추가: `git pull` → `docker-compose pull mongo` → `docker-compose up -d mongo`.
- 자주 쓰는 명령 요약표에 MongoDB 이미지 갱신 행 추가.

### 4. AI 주제 선정 안정화 (topicSelectAI.js)

- **JSON 파싱**: `\r` 제거, 후보 다양화. raw에서 `[ ]` 균형으로 배열 구간만 잘라 먼저 파싱 시도(접두 문장/마크다운 있어도 동작).
- **배열 추출**: 객체 내 배열 탐색 시 `content`, `response`, `array` 키 추가.
- **토큰**: maxOutputTokens 4096 → 8192. 실패 시 로그에 raw 길이·slice 추출 여부·앞 300자 출력.
- 프롬프트에 "JSON 배열만 출력" 지시 강화.

### 5. 본문 실사 이미지 — Unsplash 미적용 원인 및 수정

- **원인**: GitHub Secrets·deploy에서 `UNSPLASH_ACCESS_KEY`는 이미 `.env`에 주입되나, **docker-compose.yml**의 서비스 `environment`에 변수명이 없어 컨테이너로 전달되지 않음. Unsplash 검색 시 키 없음 → 0장 반환 → 전부 Pexels로 채움.
- **조치**: `docker-compose.yml`의 blog·blog-scheduler 서비스에 `UNSPLASH_ACCESS_KEY=${UNSPLASH_ACCESS_KEY}` 추가. 배포 후부터 Unsplash 우선, 부족분 Pexels 로직이 정상 동작.

---

## 참고

- CHANGELOG: [CHANGELOG.md](CHANGELOG.md)  
- 서버 명령: [SERVER_COMMANDS.md](SERVER_COMMANDS.md)
