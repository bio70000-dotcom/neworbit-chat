# 2026-02-12 수정 내역

오늘 적용한 블로그/스케줄러 관련 변경 사항 요약.

---

## 1. AI 주제 선정: JSON 모드 + raw 응답 로그

- **목적**: "Unterminated string" / "유효 줄 2개" 등 JSON·TSV 파싱 실패 반복 제거.
- **수정**: `blog/pipeline/topicSelectAI.js`
- **내용**:
  - Gemini `responseMimeType: 'application/json'` 로 JSON 출력 강제.
  - 프롬프트를 JSON 배열 요청으로 통일, 파싱은 `safeParseJSON`(마크다운 제거 후 `JSON.parse`)만 사용.
  - 매 호출 시 `[TopicSelectAI] Gemini raw 응답 본문` 로그로 디버깅 가능하도록 출력.
  - topic에 `searchVolumeLabel` / `searchVolume` 유지.

---

## 2. 주제 재선정: source 정규화 + 명령 인식·로깅

- **목적**: "2,5 다시" 등 변경 요청이 반영되지 않던 문제 해결.
- **수정**: `blog/scheduler.js`, `blog/utils/telegram.js`
- **내용**:
  - `normalizeSourceForReselect()`: plan의 source(표시명/대소문자)를 `naver_news` / `nate_trend` / `seasonal` 로 변환해 `getTopicFromSource` 호출.
  - "2번 5번 다시" 등 숫자+번+다시 패턴에서 `\d+` 추출로 1~6 번호 인식.
  - 승인 대기 시 수신 메시지·파싱 결과(type, numbers) 및 재선정 요청/성공·실패 로그 추가.

---

## 3. 초안 생성: 1편씩 순차 + 편당 대기·완료 알림

- **목적**: 6편 연속 호출 시 Gemini 타임아웃(60s) 완화.
- **수정**: `blog/scheduler.js`
- **내용**:
  - 편 사이 12초 대기(`DRAFT_GAP_MS`), 각 편 완료 시 텔레그램으로 "✅ N번 초안 완료: 키워드" 전송.

---

## 4. 초안 완료 메시지에 소제목(h2) 포함 + h2 추출 보강

- **목적**: "소제목이 안 온다" 문제 해결.
- **수정**: `blog/scheduler.js`, `blog/utils/pexelsSearch.js`
- **내용**:
  - N번 초안 완료 메시지에 `extractKeywordsFromHtml(draft.body)` 결과(소제목) 한 줄 추가.
  - `extractKeywordsFromHtml`: h2 내용 추출 시 `(.*?)` → `([\s\S]*?)` 로 줄바꿈 포함, 빈 HTML 처리 및 길이 상한 80자.

---

## 5. 1~6번 고정 순서: 소제목 보고 → 사진 수집 → 스케줄 생성

- **목적**: 주제 보고 번호와 사진 요청 번호가 뒤섞이거나 건너뛰던 현상 제거.
- **수정**: `blog/scheduler.js`
- **내용**:
  - **plan 순서 고정**: `assignTimesToPosts`에 `planIndex`(1~6) 부여. 사진 매칭은 `item.planIndex` 사용.
  - **흐름 변경**: 초안 6편 완료 후, "한 번에 소제목 보고" 제거 → **1번 소제목 보고 → 1번 사진 수집 → 2번 소제목 → 2번 사진 → … → 6번** 순으로 진행.
  - 6번까지 사진 수집 완료 후에만 `assignTimesToPosts(plan, times)` 호출해 발행 스케줄 생성.
  - `formatSubheadingsReport` 사용 제거(편당 메시지로 대체).

---

## 6. 기타

- `docs/LOG_VIEW.md` 삭제 상태 유지(별도 커밋 없음).
- `.cursor/rules/` 는 로컬 설정으로 푸시 대상 아님.
