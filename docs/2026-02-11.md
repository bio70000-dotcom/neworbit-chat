# 2026-02-11 수정 내역

오늘 적용한 블로그/스케줄러 관련 변경 사항 요약.

---

## 1. 텔레그램 스케줄러 제어 (멈춤/재개/상태)

- **목적**: 대기 중 "상태" 조회, 일시정지/재개 가능하게.
- **수정**: `blog/utils/telegram.js`, `blog/scheduler.js`, `docs/TELEGRAM_COMMANDS.md` 신규
- **내용**:
  - `checkForSchedulerCommand()`: 멈춤/재개/상태/시작 구분 반환.
  - 스케줄러 상태 변수(`schedulerState`, `currentSchedule`, `schedulerPaused`) 및 `formatSchedulerStatus()` 추가.
  - 명령어 정리 문서 추가.

---

## 2. 구글 트렌드 한글 우선, 영어 fallback

- **목적**: 영어만 있는 트렌드보다 한글 포함 트렌드를 우선 사용.
- **수정**: `blog/utils/googleTrends.js`
- **내용**: `getTrendingKeywords()`에서 한글 포함 제목을 먼저 나열, 부족분은 영어만 제목으로 채움.

---

## 3. 스케줄 번호 통일 + 사진 중복 제거 + 로깅

- **목적**: "1번" 사진이 2번 글로 들어가던 문제 해결, 같은 사진 중복 삽입 방지, 봇 무응답 원인 추적.
- **수정**: `blog/scheduler.js`, `blog/utils/telegram.js`
- **내용**:
  - `assignTimesToPosts()`: 시간순 정렬 후 index 1~6 재부여 → 소제목/스케줄/실행 번호 일치.
  - 사진 배정을 `item.index`로 통일, `file_id` 기준 중복 제거(한 장만 사용).
  - 명령 폴링 15초, getUpdates/명령 매칭/sendMessage 실패 시 로깅.

---

## 4. 초안 실패 원인 분석

- **목적**: "This operation was aborted" 등 초안 실패 시 단계·타임아웃 구분.
- **수정**: `blog/agent.js`, `blog/pipeline/draftWriter.js`, `blog/scheduler.js`
- **내용**:
  - `generateDraftOnly()`에서 리서치/초안 단계별로 에러 메시지 prefix (`research:`, `writeDraft:`).
  - Gemini Abort 시 "Gemini timeout (60s) or aborted" 메시지로 반환.
  - 실패 시 스택 로그 출력.

---

## 5. Option A: 봇 응답/무시 대응

- **목적**: flush 오동작 방지, 전송 실패 시 재시도, 블라인드 구간 안내.
- **수정**: `blog/utils/telegram.js`, `docs/TELEGRAM_COMMANDS.md`
- **내용**:
  - `flushUpdates()`: `offset=-1` 제거, `getUpdates(0)`로 lastUpdateId만 정리.
  - `sendMessage()`: 실패 시 최대 2회 재시도(1.5초 간격).
  - §6 블라인드 구간: 초안 생성/발행 중에는 명령 미수신 안내.

---

## 6. 사진 번호 매칭 개선 (안 A + 안 B)

- **목적**: 소제목 1번과 스케줄 1번이 달라 사진이 잘못 배정되던 문제 해결.
- **수정**: `blog/scheduler.js`, `blog/utils/telegram.js`, `docs/TELEGRAM_COMMANDS.md`
- **내용**:
  - **안 A**: 초안 직후 times/schedule 생성 → 소제목을 **스케줄 순서**로 보고 (1번 정의 통일).
  - **안 B**: 1~6번 순차 수집. `waitForPhotosForSlot(postIndex, keyword, maxPhotos)`로 N번 글당 사진 수집 후 "다음"/"스킵"으로 진행.

---

## 7. 글당 사진 최대 3장, 대기 무제한, 발행 11:00~22:00

- **목적**: 글당 1~3장 지원, 업무 중에도 여유 있게 사진 전송, 발행 구간 명확화.
- **수정**: `blog/utils/telegram.js`, `blog/scheduler.js`, `docs/TELEGRAM_COMMANDS.md`
- **내용**:
  - `waitForPhotosForSlot(postIndex, keyword, maxPhotos=3)`: 글당 최대 3장, "다음"/"스킵" 입력 시 다음 번호. **타임아웃 없음**(메시지 올 때까지 대기).
  - 발행 구간 **11:00~22:00** KST (`PUBLISH_START_HOUR` 10→11).
  - 23시 포스팅 결과 보고는 기존 유지.

---

## 커밋 요약 (오늘 푸시)

- `4b748fe` Telegram scheduler control + command docs  
- `3a85e39` Google Trends 한글 우선, 영어 fallback  
- `29a2161` schedule index fix, photo dedupe, Telegram logging  
- `3e25cab` draft failure cause analysis  
- `b534748` Option A: flushUpdates, sendMessage retry, blind-period docs  
- `5b114cd` photo slot 3장, no timeout wait, publish 11:00–22:00  

(그 외 플랜 적용 커밋: 소제목/스케줄 번호 통일, 순차 사진 수집 등은 위 5b114cd 이전 커밋에 포함됨)
